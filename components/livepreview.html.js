"use strict";!function(){angular.module("w69b.promiseTool",[]).factory("promiseTool",["$q","$timeout",function(e,r){var n={};return n.wrapChromeError=function(r,n){return function(){var t=Array.prototype.slice.call(arguments,0),o=e.defer();return t.push(function(e){chrome.runtime.lastError?o.reject(chrome.runtime.lastError):o.resolve(e)}),r.apply(n,t),o.promise}},n.wrapCallbacks=function(r,n){return function(){var t=Array.prototype.slice.call(arguments,0),o=e.defer();return t.push(o.resolve.bind(o)),t.push(o.reject.bind(o)),r.apply(n,t),o.promise}},n.serializer=function(){var r=null;return function(n){var t=e.defer();return(r||e.when())["finally"](function(){var e=n.call();t.resolve(e)}),r=t.promise,r["finally"](function(){r=null}),t.promise}},n.withTimeout=function(n,t,o){o||(o=angular.noop);var i=e.defer(),a=r(function(){var e=o();angular.isDefined(e)?i.resolve(e):i.reject("timeout"),i=null},t),c=n(),s=i.promise;return c["finally"](function(){r.cancel(a),a=null}),c.then(function(){i&&i.resolve.apply(i,arguments)},function(){i&&i.reject.apply(i,arguments)}),s},n}]),angular.module("w69b.chromeRuntime",["w69b.promiseTool"]).factory("chromeRuntime",["promiseTool",function(e){var r={};return r.sendMessage=e.wrapChromeError(chrome.runtime.sendMessage,chrome.runtime),r.getBackgroundPage=e.wrapChromeError(chrome.runtime.getBackgroundPage,chrome.runtime),r.connect=chrome.runtime.connect.bind(chrome.runtime),r.getManifest=chrome.runtime.getManifest.bind(chrome.runtime),r.id=chrome.runtime.id,chrome.runtime.getPlatformInfo&&(r.getPlatformInfo=e.wrapChromeError(chrome.runtime.getPlatformInfo,chrome.runtime)),["onMessage","onMessageExternal","onConnect","onConnectExternal","onInstalled","onSuspend"].forEach(function(e){r[e]={addListener:function(r){chrome.runtime[e].addListener(r)},removeListener:function(r){chrome.runtime[e].removeListener(r)}}}),r}]),angular.module("w69b.timeutil",[]).factory("timeutil",function(){var e={};return e.formatDuration=function(e){function r(e){return 10>e?"0"+e:e}angular.isNumber(e)||(e=0);var n="";0>e&&(n="-",e=-e);var t=Math.floor(e%60),o=Math.floor(e/60%60),i=[r(o),r(t)],a=Math.floor(e/3600);return a&&i.unshift(a),n+i.join(":")},e}).filter("duration",["timeutil",function(e){return function(r){return e.formatDuration(r||0)}}]),angular.module("w69b.chromePermissions",["w69b.promiseTool"]).factory("chromePermissions",["promiseTool",function(e){var r=window.chrome&&window.chrome.permissions,n={};return r?(n.contains=e.wrapChromeError(r.contains,r),n.request=e.wrapChromeError(r.request,r),n.remove=e.wrapChromeError(r.remove,r),n.getAll=e.wrapChromeError(r.getAll,r),n):n}]),angular.module("w69b.spawn",[]).factory("spawn",["$q","$log",function(e,r){function n(r,n){function t(e,r){var n;try{n=e(r)}catch(t){return o(t)}return n.done?i(n.value):i(n.value).then(c,s)}var o=n?Promise.reject.bind(Promise):e.reject.bind(e),i=n?Promise.resolve.bind(Promise):e.when.bind(e),a=r(),c=t.bind(null,a.next.bind(a)),s=t.bind(null,a["throw"].bind(a));return c()}return n.wrap=function(e){return function(){var t,o=arguments,i=n((t=e).bind.apply(t,$traceurRuntime.spread([this],o)));return i["catch"](function(e){r.error("unhandled spawn.wrap rejection:",e),e.stack&&console.error(e.stack)}),i}},n}]),angular.module("castifyExt.recorder",["castifyExt.backgroundTool","castifyExt.optionalPermissions","w69b.spawn"]).factory("recorder",["backgroundTool","optionalPermissions","spawn","$q",function(e,r,n,t){var o=e.portHelper("recorder",!1),i={};i.info={};var a={};return a.stateUpdate=function(e){angular.copy(e,i.info)},o.installHandlers(a),i.start=n.wrap($traceurRuntime.initGeneratorFunction(function c(e){var n;return $traceurRuntime.createGeneratorInstance(function(i){for(;;)switch(i.state){case 0:i.state="tab"===e.captureSource?1:6;break;case 1:return i.state=2,r.requestTabPermissions(e);case 2:n=i.sent,i.state=4;break;case 4:i.state=n?6:5;break;case 5:i.returnValue=t.reject("tab_permissions"),i.state=-2;break;case 6:i.returnValue=o.postMessage("start",e),i.state=-2;break;default:return i.end()}},c,this)})),i.stop=function(){o.postMessage("stop")},i.pause=function(){o.postMessage("pause")},i.resume=function(){o.postMessage("resume")},i.replaceStream=function(e){o.postMessage("replaceStream",e)},i.cancelPendingStart=function(){o.postMessage("cancelPendingStart")},i.showPreview=function(e){o.postMessage("showPreview",e)},o.getPort(),i}]),angular.module("castifyExt.backgroundTool",["w69b.chromeRuntime"]).factory("backgroundTool",["chromeRuntime","$q","$log","$rootScope",function(e,r,n,t){function o(){var n=r.defer();return e.onMessage.addListener(function t(r){"bg:loaded"===r&&(e.onMessage.removeListener(t),n.resolve())}),e.sendMessage("bg:load"),n.promise}var i,a={};return a.portHelper=function(n,i){var a,c={};return c.getPort=function(){var t=i===!1?r.when():o();return t.then(function(){return a||(a=e.connect({name:n})),a})},c.postMessage=function(e,r){return c.getPort().then(function(n){return n.postMessage({type:e,data:r})})},c.installHandlers=function(e){function r(r){e.hasOwnProperty(r.type)&&e[r.type](r.data),t.$$phase||t.$apply()}function n(){c.getPort().then(function(e){e.onMessage.removeListener(r)})}return c.getPort().then(function(e){e.onMessage.addListener(r)}),n},c},a.loadBackground=function(){return i||(i=o()),i},a}]),angular.module("castifyExt.ui.themeConfig",["ngMaterial"]).config(["$mdThemingProvider",function(e){e.theme("default").primaryPalette("orange",{"default":"800","hue-1":"300","hue-2":"600","hue-3":"900"}).accentPalette("pink")}]).config(["$mdIconProvider",function(e){e.defaultIconSet("gen/icons.svg")}]),angular.module("castifyExt.ui.livepreview",["w69b.promiseTool","w69b.timeutil","castifyExt.recorder","castifyExt.ui.loadingOverlay","ngMaterial"]).directive("cfLivePreviewCanvas",["recorder","$window",function(e,r){return{restrict:"EA",templateUrl:"components/castifyExt/ui/livepreview/livePreviewCanvas.html",replace:!0,scope:{},link:function(n,t,o){function i(e,r){var n=Math.min(r.width/e.width,r.height/e.height);return{width:e.width*n,height:e.height*n}}function a(e,r){return{width:e.width*r,height:e.height*r}}function c(e){return{width:e[0].videoWidth,height:e[0].videoHeight}}function s(){var r,n,o;if(d.screen){var s=t[0].getBoundingClientRect();r=c(l),r=i(r,s),o=Math.floor((s.width-r.width)/2),n=Math.floor((s.height-r.height)/2);var u=a(r,g);m.css({top:n+"px",right:o+"px",width:u.width+"px",height:u.height+"px"}),l.removeClass("ng-hide")}if(d.cam&&d.screen){var p=c(f);p=i(p,a(r,h));var v=e.info.config.camPosition,w={width:p.width+"px",height:p.height+"px"};switch(v){case"topLeft":w.top=n+"px",w.left=o+"px";break;case"topRight":w.top=n+"px",w.right=o+"px";break;case"bottomLeft":w.bottom=n+"px",w.left=o+"px";break;default:w.bottom=n+"px",w.right=o+"px"}f.css(w),f.removeClass("ng-hide")}else f.addClass("ng-hide")}var u=t.find("video"),l=u.eq(0),f=u.eq(1),m=t.find("cf-live-branding"),d={cam:!1,screen:!1},p=angular.element(r),h=o.camSizeRatio||.3,g=o.brandingSizeRatio||.2;f[0].volume=0,l[0].volume=0,f.bind("canplay",function(){d.cam=!0,s()}),l.bind("canplay",function(){d.screen=!0,s()}),n.$watch(function(){return e.info.videoUrl},function(e){e&&l.attr("src",e)}),n.$watch(function(){return e.info.cameraUrl},function(e){e&&f.attr("src",e)}),n.$watch(function(){return e.info&&e.info.config&&e.info.config.brandingFilename},function(e){n.branding=!!e}),p.bind("resize",s),t.bind("$destroy",function(){p.unbind("resize",s)})}}}]).controller("LivePreviewCtrl",["$scope","recorder",function(e,r){e.recorder=r}]),angular.module("castifyExt.ui.loadingOverlay",[]).directive("cfLoadingBackdrop",function(){return{restrict:"E",template:'<md-progress-circular md-mode="indeterminate"></md-progress-circular>'}}).directive("cfLoadingOverlay",["$compile",function(e){return{restrict:"A",link:function(r,n,t){var o=null;r.$watch(t.cfLoadingOverlay,function(t){t?(o=e("<cf-loading-backdrop></cf-loading-backdrop>")(r),n.append(o)):o&&(o.remove(),o=null)})}}}]),angular.module("castifyExt.optionalPermissions",["w69b.chromePermissions"]).factory("optionalPermissions",["chromePermissions",function(e){function r(e){return e&&(!e.draw||e.draw&&!e.draw.showToolbox&&null===e.draw.tool)?o:t}var n={},t={permissions:["tabCapture","webNavigation","activeTab"],origins:["<all_urls>"]},o={permissions:["tabCapture","webNavigation","activeTab"],origins:[]};return n.hasLiteTabPermissions=function(){return e.contains(o)},n.hasTabPermissions=function(n){return e.contains(r(n))},n.requestTabPermissions=function(n){return e.request(r(n))},n}]),angular.module("castifyExt.LivePreviewApp",["castifyExt.ui.livepreview","castifyExt.ui.themeConfig"]).config(["$sceDelegateProvider",function(e){e.resourceUrlWhitelist(["self","http://localhost:9008/**","blob:**","filesystem:chrome-extension://**"])}]),angular.module("castifyExt.LivePreviewApp").requires.push("templates")}();